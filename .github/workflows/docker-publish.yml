# 工作流名称：Docker 镜像构建与推送
name: Docker Build and Push

# 触发条件：仅当代码推送到 main 分支时触发
on:
  push:
    branches: ["main"]

# 权限配置：按需最小化授权（读取代码、写入镜像仓库）
permissions:
  contents: read        # 允许读取仓库代码
  packages: write       # 允许推送镜像到 GitHub Packages

# 定义任务集合
jobs:
  # 任务1：代码测试（前置校验）
  test:
    runs-on: ubuntu-latest  # 运行环境：GitHub 托管的最新 Ubuntu 虚拟机
    steps:
      # 步骤1：拉取仓库代码到运行器
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：配置 Node.js 环境（匹配项目依赖的 18 版本）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 步骤3：安装项目依赖（package.json 中定义的依赖）
      - name: Install dependencies
        run: npm install

      # 步骤4：执行测试脚本（package.json 中的 test 命令）
      - name: Run tests
        run: npm test

  # 任务2：构建并推送 Docker 镜像（依赖 test 任务成功）
  build-and-push:
    needs: test              # 依赖关系：仅 test 任务通过后才执行
    runs-on: ubuntu-latest   # 运行环境：与测试任务一致
    steps:
      # 步骤1：拉取仓库代码（需重新拉取，每个任务独立环境）
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：配置 Docker Buildx（增强版构建工具，支持多平台/缓存）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤3：登录 GitHub 容器镜像仓库（GHCR）
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io                        # 镜像仓库地址
          username: ${{ github.actor }}            # 登录用户名（当前触发操作的 GitHub 用户）
          password: ${{ secrets.GITHUB_TOKEN }}    # 登录密钥（GitHub 自动生成，无需手动配置）

      # 步骤4：构建并推送 Docker 镜像
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .                               # 构建上下文：当前目录（包含 Dockerfile 和项目代码）
          push: true                               # 开启推送镜像到仓库
          # 镜像标签：仓库所有者/项目名:版本（必须全小写，GHCR 强制要求）
          tags: ghcr.io/${{ github.repository_owner }}/ci-cd-practice:latest
